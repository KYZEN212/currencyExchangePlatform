<!DOCTYPE html>
<html>
    <head>
        <title>Human Verification</title>
        <style>
            *{
                 box-sizing:border-box;
                 margin: 0;
                 padding: 0;
            }

            body{
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                height:100vh;
                background: linear-gradient(135deg, #e8f6ff 0%, #95dfff 25%, #8086ff 65%, #8b76e6 100%);
                display:flex;
                justify-content:center;
                align-items:center;
                padding: 20px;
            }

            .container{
                width:100%;
                max-width:500px;
                background:#ffffff;
                box-shadow:0 10px 30px rgba(0,0,0,0.15);
                text-align:center;
                padding: 25px;
                border-radius:16px;
                transition: transform 0.3s ease;
            }

            .container:hover {
                transform: translateY(-5px);
            }

            h3{
                text-align:center;
                margin: 15px 0;
                color: #2d3748;
                font-weight: 600;
            }

            .imgbox{
                width:100%;
                display:grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin: 20px 0;
            }

            label{ 
                margin:0; 
                padding:0; 
                position: relative; 
                display:inline-block; 
                border-radius: 10px;
                overflow: hidden;
                transition: all 0.2s ease;
                cursor: pointer;
            }

            label:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

            label img{
                width:100%;
                height: 120px;
                object-fit:cover;
                border-radius:10px;
                transition:all 0.2s ease;
                display: block;
            }

            .btn{
                font-size:15px;
                font-weight:600;
                background: linear-gradient(135deg, #8086ff 0%, #8b76e6 100%);
                color:#fff;
                border:none;
                padding: 12px 20px;
                cursor:pointer;
                transition:all 0.3s ease;
                margin-left: 10px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(128, 134, 255, 0.3);
            }

            .btn:hover{
                transform: translateY(-2px);
                box-shadow: 0 6px 18px rgba(128, 134, 255, 0.4);
            }

            .btn-secondary {
                background: #6b7280;
            }

            .btn-secondary:hover {
                background: #4b5563;
            }

            .answer:checked + label {
                border: 3px solid #10b981;
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            }

            .answer:checked + label > img{
                filter: brightness(0.9);
            }

            /* Enhanced selection indicator */
            .answer:checked + label::after{
                content: '\2713'; /* ✓ */
                position: absolute;
                top: 8px;
                right: 8px;
                width: 24px;
                height: 24px;
                background: #10b981;
                color: white;
                font-weight: 700;
                font-size: 14px;
                line-height: 24px;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .helper{
                font-size: 15px;
                margin: 10px 0 20px;
                color: #6b7280;
            }

            /* Top notification banner */
            .notice {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                padding: 15px 20px;
                text-align: center;
                font-weight: 600;
                z-index: 9999;
                display: none;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .notice--error { 
                background: #fee2e2; 
                color: #991b1b; 
                border-bottom: 1px solid #fecaca; 
            }
            .notice--success { 
                background: #dcfce7; 
                color: #14532d; 
                border-bottom: 1px solid #bbf7d0; 
            }

            .helper--warn { 
                color: #ef4444; 
                font-weight: 600;
            }

            /* Header and actions */
            .modal-header { 
                position: relative; 
                display:flex; 
                align-items:center; 
                justify-content:space-between;
                margin-bottom: 10px;
                padding-bottom: 15px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .modal-title {
                font-weight: 700; 
                color: #2d3748;
                font-size: 18px;
            }
            
            .close-btn { 
                background:transparent; 
                border:none; 
                color:#9ca3af; 
                font-size:20px; 
                cursor:pointer; 
                line-height:1; 
                padding:5px; 
                transition: color 0.2s ease;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
            }
            
            .close-btn:hover {
                color: #4b5563;
                background: #f3f4f6;
            }
            
            .actions { 
                display:flex; 
                justify-content:space-between; 
                align-items:center; 
                margin-top: 25px;
            }
            
            .progress {
                display: flex;
                justify-content: center;
                margin: 15px 0;
                gap: 8px;
            }
            
            .progress-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background-color: #d1d5db;
                transition: all 0.3s ease;
            }
            
            .progress-dot.active {
                background-color: #8086ff;
                transform: scale(1.2);
            }
            
            .progress-dot.completed {
                background-color: #10b981;
            }

        </style>
    </head>
    <body>
        <!-- Notification banner (hidden initially) -->
        <div id="notice" class="notice"></div>

        <div id="container" class="container">
            <div class="modal-header">
                <div class="modal-title">Verify you are human</div>
                <button type="button" class="close-btn" id="closeBtn" aria-label="Close">✕</button>
            </div>
            
            <div class="progress">
                <div class="progress-dot active" id="progress1"></div>
                <div class="progress-dot" id="progress2"></div>
                <div class="progress-dot" id="progress3"></div>
            </div>
            
            <h3 class="question">Select all images with traffic lights</h3>
            <div class="helper">Choose exactly 3 images, then click Verify.</div>

            <div class="imgbox">
                <input type="checkbox" name="answer" id="a" class="answer" hidden />
                <label for="a">
                    <img src="https://images.unsplash.com/photo-1545431766-45ff67845191?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option1" id="a_img" />
                </label>

                <input type="checkbox" name="answer" id="b" class="answer" hidden />
                <label for="b">
                    <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option2" id="b_img" />
                </label>

                <input type="checkbox" name="answer" id="c" class="answer" hidden />
                <label for="c">
                    <img src="https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option3" id="c_img" />
                </label>

                <input type="checkbox" name="answer" id="d" class="answer" hidden />
                <label for="d">
                    <img src="https://images.unsplash.com/photo-1551963831-b3b1ca40c98e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option4" id="d_img" />
                </label>

                <input type="checkbox" name="answer" id="e" class="answer" hidden />
                <label for="e">
                    <img src="https://images.unsplash.com/photo-1549289524-06cf8837ace5?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option5" id="e_img" />
                </label>

                <input type="checkbox" name="answer" id="f" class="answer" hidden />
                <label for="f">
                    <img src="https://images.unsplash.com/photo-1551963831-b3b1ca40c98e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option6" id="f_img" />
                </label>

                <input type="checkbox" name="answer" id="g" class="answer" hidden />
                <label for="g">
                    <img src="https://images.unsplash.com/photo-1545431766-45ff67845191?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option7" id="g_img" />
                </label>

                <input type="checkbox" name="answer" id="h" class="answer" hidden />
                <label for="h">
                    <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option8" id="h_img" />
                </label>

                <input type="checkbox" name="answer" id="i" class="answer" hidden />
                <label for="i">
                    <img src="https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="option9" id="i_img" />
                </label>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-secondary" id="refreshBtn">Refresh</button>
                <button type="button" class="btn" id="verifyBtn">Verify</button>
            </div>
        </div>
   

        <script>
            // 3-step human verification with randomized images each time.
            const pools = {
                traffic: [
                    'https://images.unsplash.com/photo-1545431766-45ff67845191?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1551963831-b3b1ca40c98e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60'
                ],
                mountains: [
                    'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1545431766-45ff67845191?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1551963831-b3b1ca40c98e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60'
                ],
                animals: [
                    'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1549289524-06cf8837ace5?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1545431766-45ff67845191?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60'
                ],
                others: [
                    'https://images.unsplash.com/photo-1549289524-06cf8837ace5?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1551963831-b3b1ca40c98e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1545431766-45ff67845191?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
                    'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60'
                ]
            };

            function shuffle(arr){
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

            function sampleN(arr, n){
                if (n <= 0) return [];
                const copy = arr.slice();
                shuffle(copy);
                return copy.slice(0, Math.min(n, copy.length));
            }

            const stepsMeta = [
                { prompt: 'Select all images with traffic lights', target: 'traffic' },
                { prompt: 'Select all images with mountains',      target: 'mountains' },
                { prompt: 'Select all images with animals',        target: 'animals' }
            ];

            function generateStep(meta){
                const targetPool = pools[meta.target] || [];
                // Non-target distractors are drawn from all other pools
                const distractorPool = Object.keys(pools)
                    .filter(k => k !== meta.target)
                    .reduce((acc, k) => acc.concat(pools[k]), []);

                const correctFiles = sampleN(targetPool, 3);
                const distractorFiles = sampleN(distractorPool, 6);
                const all = correctFiles.map(f => ({ file: f, correct: true }))
                            .concat(distractorFiles.map(f => ({ file: f, correct: false })));
                shuffle(all);

                const ids = ['a','b','c','d','e','f','g','h','i'];
                const images = {};
                const correct = new Set();
                ids.forEach((id, idx) => {
                    const item = all[idx];
                    images[id] = item.file;
                    if (item.correct) correct.add(id);
                });

                return { prompt: meta.prompt, images, correct };
            }

            let steps = stepsMeta.map(generateStep);

            const required = 3;
            const container = document.getElementById('container');
            const verifyBtn = document.getElementById('verifyBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const closeBtn = document.getElementById('closeBtn');
            const questionEl = document.querySelector('.question');
            const helperEl = document.querySelector('.helper');
            const noticeEl = document.getElementById('notice');
            const progressDots = [
                document.getElementById('progress1'),
                document.getElementById('progress2'),
                document.getElementById('progress3')
            ];
            
            const imgEls = {
                a: document.getElementById('a_img'),
                b: document.getElementById('b_img'),
                c: document.getElementById('c_img'),
                d: document.getElementById('d_img'),
                e: document.getElementById('e_img'),
                f: document.getElementById('f_img'),
                g: document.getElementById('g_img'),
                h: document.getElementById('h_img'),
                i: document.getElementById('i_img'),
            };

            let stepIndex = 0;
            let successCount = 0;
            let failCount = 0;

            function showNotice(message, type = 'error'){
                noticeEl.textContent = message;
                noticeEl.className = 'notice ' + (type === 'success' ? 'notice--success' : 'notice--error');
                noticeEl.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    noticeEl.style.display = 'none';
                }, 5000);
            }

            function updateProgress() {
                progressDots.forEach((dot, index) => {
                    dot.classList.remove('active', 'completed');
                    
                    if (index < stepIndex) {
                        dot.classList.add('completed');
                    } else if (index === stepIndex) {
                        dot.classList.add('active');
                    }
                });
            }

            function loadStep(idx){
                const step = steps[idx];
                questionEl.textContent = step.prompt;
                helperEl.textContent = 'Choose exactly 3 images, then click Verify.';
                helperEl.classList.remove('helper--warn');
                for (const key of Object.keys(imgEls)) {
                    imgEls[key].src = step.images[key];
                }
                // clear selections
                document.querySelectorAll('.answer').forEach(cb => cb.checked = false);
                
                updateProgress();
            }

            function getSelected() {
                return Array.from(document.querySelectorAll('.answer:checked')).map(el => el.id);
            }

            loadStep(stepIndex);

            // Refresh: reshuffle and reset to first step
            refreshBtn.addEventListener('click', function(){
                steps = stepsMeta.map(generateStep);
                stepIndex = 0;
                successCount = 0;
                failCount = 0;
                loadStep(stepIndex);
            });

            // Close: navigate back one page if possible
            closeBtn.addEventListener('click', function(){
                if (history.length > 1) history.back();
                else window.location.href = 'registration.html';
            });

            verifyBtn.addEventListener('click', function(){
                const selected = getSelected();
                if (selected.length !== required) {
                    helperEl.textContent = `Please select exactly ${required} images.`;
                    helperEl.classList.add('helper--warn');
                    return;
                }
                const correctSet = steps[stepIndex].correct;
                const ok = selected.every(id => correctSet.has(id));

                if (ok) {
                    successCount += 1;
                } else {
                    failCount += 1;
                }

                // Advance to next step or finish
                stepIndex += 1;
                if (stepIndex < steps.length) {
                    loadStep(stepIndex);
                } else {
                    // Finished 3 attempts. Fail if there is any failed step (1, 2, or 3 out of 3)
                    if (failCount >= 1) {
                        showNotice(`Verification failed. You failed ${failCount} out of 3 attempts.`,'error');
                        // Refresh images for a new run: regenerate steps and reset counters
                        steps = stepsMeta.map(generateStep);
                        stepIndex = 0;
                        successCount = 0;
                        failCount = 0;
                        loadStep(stepIndex);
                    } else {
                        // Notify parent window that CAPTCHA was verified
                        if (window.opener) {
                            window.opener.postMessage('captcha-verified', window.location.origin);
                        }
                        
                        showNotice('Verification successful! Closing...', 'success');
                        setTimeout(() => {
                            window.close();
                        }, 1000);
                    }
                }
            });
        </script>
    
    </body>
</html>
<!DOCTYPE html>
<html>
    <head>
        <title>Human Verification</title>
        <style>
            *{
                 box-sizing:border-box;
            }

            body{
                font-family:sans-serif;
                height:100vh;

                display:flex;
                justify-content:center;
                align-items:center;
            }

            .container{
                width:100%;
                max-width:420px;
                background:#f4f4f4;
                box-shadow:0 0 10px rgba(0,0,0,0.3);
                text-align:center;
                padding:8px;
                border-radius:10px;
            }

            h3{
                text-align:center;
            }

            .imgbox{
                width:100%;
                display:grid;
                grid-template-columns: repeat(3, max-content);
                column-gap:15px;
                row-gap:8px;
                justify-items:center;
                justify-content:center;
                margin-top:8px;
            }

            label{ margin:0; padding:0; position: relative; display:inline-block; }
            label img{
                width:120px;
                height:100px;
                object-fit:cover;
                border-radius:6px;
                transition:all 0.1s ease;
            }

            label img:hover{
                opacity:0.8;
                filter:blur(1.5px);
            }

            .btn{
                width:auto;
                font-size:14px;
                font-weight:bold;
                background-color:steelblue;
                color:#fff;
                border:none;
                padding:7px 12px;
                cursor:pointer;
                transition:all 0.3s ease;
                margin-left: 8px;
                border-radius: 6px;
            }

            .btn_login{
                width:50%;
                font-size:14px;
                font-weight:bold;
                background-color:steelblue;
                color:#fff;
                border:none;
                padding:7px;
                cursor:pointer;
                transition:all 0.3s ease;
                margin: 5px;
                border-radius: 6px;
            }

            .btn:hover{
                background:darkblue;
            }

            .answer:checked + label > img{
                transform:scale(1.02);
                filter: brightness(0.9);
                opacity: 0.6;
            }

            /* Plain green tick on selected (no background) */
            .answer:checked + label::after{
                content: '\2713'; /* ✓ */
                position: absolute;
                top: 6px;
                right: 6px;
                color: #10b981;
                font-weight: 700;
                font-size: 18px;
                line-height: 1;
                text-shadow: 0 1px 0 rgba(255,255,255,0.6);
            }

            .helper{
                font-size: 14px;
                margin-bottom: 15px;
                display: none; /* hide default tip */
            }

            /* Top notification banner */
            .notice {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                padding: 12px 16px;
                text-align: center;
                font-weight: 600;
                z-index: 9999;
                display: none; /* hidden by default */
            }
            .notice--error { background: #fee2e2; color: #991b1b; border-bottom: 1px solid #fecaca; }
            .notice--success { background: #dcfce7; color: #14532d; border-bottom: 1px solid #bbf7d0; }

            .helper--warn { color: #b91c1c; display:block; }

            /* Header and actions */
            .modal-header { position: relative; display:flex; align-items:center; justify-content:flex-start; }
            .close-btn { position:absolute; right:6px; top:0; background:transparent; border:none; color:#111; font-size:16px; cursor:pointer; line-height:1; padding:4px 6px; }
            .actions { display:flex; justify-content:flex-end; align-items:center; padding: 0 8px 8px; }

        </style>
    </head>
    <body>
        <!-- Notification banner (hidden initially) -->
        <div id="notice" class="notice"></div>

        <div id="container" class="container">
            <div class="modal-header">
                <div style="font-weight:700; color:#111827;">Verify you are human</div>
                <button type="button" class="close-btn" id="closeBtn" aria-label="Close">✕</button>
            </div>
            <h3 class="question">Select all images with traffic lights</h3>
            <div class="helper">Choose exactly 3 images, then click Verify.</div>

            <div class="imgbox">
              

               <input type="checkbox" name="answer" id="a" class="answer" hidden /><label for="a"><img src="./../image/mountain_1.jpg" 
            alt="option1" id="a_img" /></label>

               <input type="checkbox" name="answer" id="c" class="answer" hidden /><label for="c"><img src="./../image/cat_1.jpg" alt="option3" id="c_img" /></label>

               <input type="checkbox" name="answer" id="d" class="answer" hidden /><label for="d"><img src="./../image/traffic_light_2.jpg" alt="option4" id="d_img" /></label>

               <input type="checkbox" name="answer" id="e" class="answer" hidden /><label for="e"><img src="./../image/bed_1.jpg" alt="option5" id="e_img" /></label>

               <input type="checkbox" name="answer" id="f" class="answer" hidden /><label for="f"><img src="./../image/traffic_light_3.jpg" alt="option6" id="f_img" /></label>

               <input type="checkbox" name="answer" id="g" class="answer" hidden /><label for="g"><img src="./../image/chair_1.jpg" alt="option7" id="g_img" /></label>

               <input type="checkbox" name="answer" id="h" class="answer" hidden /><label for="h"><img src="./../image/road_1.jpg" alt="option8" id="h_img" /></label>

               <input type="checkbox" name="answer" id="i" class="answer" hidden /><label for="i"><img src="../image/bed_1.jpg" alt="option9" id="i_img" /></label>

            </div>

            <div class="actions">
                <button type="button" class="btn" id="refreshBtn" style="background:#6b7280;">Refresh</button>
                <button type="button" class="btn" id="verifyBtn">Verify</button>
            </div>
        </div>
   

        <script>
            // 3-step human verification with randomized images each time.
            // Add any new images you placed in /image to these pools.
            const pools = {
                traffic: [
                    'traffic_light_1.jpg','traffic_light_2.jpg','traffic_light_3.jpg','traffic_light_4.jpg'
                ],
                mountains: [
                    'mountain_1.jpg','mountain_2.jpg','mountain_3.jpg','mountain_4.jpg'
                ],
                animals: [
                    'cat_1.jpg','bird_3.jpg','tiger_1.jpg','dog_1.jpg'
                ],
                others: [
                    'bed_1.jpg','chair_1.jpg','chair_2.jpg','bed_3.jpg'
                ]
            };

            function shuffle(arr){
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

            function sampleN(arr, n){
                if (n <= 0) return [];
                const copy = arr.slice();
                shuffle(copy);
                return copy.slice(0, Math.min(n, copy.length));
            }

            const stepsMeta = [
                { prompt: 'Select all images with traffic lights', target: 'traffic' },
                { prompt: 'Select all images with mountains',      target: 'mountains' },
                { prompt: 'Select all images with animals',        target: 'animals' }
            ];

            function generateStep(meta){
                const targetPool = pools[meta.target] || [];
                // Non-target distractors are drawn from all other pools
                const distractorPool = Object.keys(pools)
                    .filter(k => k !== meta.target)
                    .reduce((acc, k) => acc.concat(pools[k]), []);

                const correctFiles = sampleN(targetPool, 3);
                const distractorFiles = sampleN(distractorPool, 6);
                const all = correctFiles.map(f => ({ file: f, correct: true }))
                            .concat(distractorFiles.map(f => ({ file: f, correct: false })));
                shuffle(all);

                const ids = ['a','b','c','d','e','f','g','h','i'];
                const images = {};
                const correct = new Set();
                ids.forEach((id, idx) => {
                    const item = all[idx];
                    images[id] = `./image/${item.file}`;
                    if (item.correct) correct.add(id);
                });

                return { prompt: meta.prompt, images, correct };
            }

            let steps = stepsMeta.map(generateStep);

            const required = 3;
            const container = document.getElementById('container');
            const verifyBtn = document.getElementById('verifyBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const closeBtn = document.getElementById('closeBtn');
            const questionEl = document.querySelector('.question');
            const helperEl = document.querySelector('.helper');
            const noticeEl = document.getElementById('notice');
            const imgEls = {
                a: document.getElementById('a_img'),
                b: document.getElementById('b_img'),
                c: document.getElementById('c_img'),
                d: document.getElementById('d_img'),
                e: document.getElementById('e_img'),
                f: document.getElementById('f_img'),
                g: document.getElementById('g_img'),
                h: document.getElementById('h_img'),
                i: document.getElementById('i_img'),
            };

            let stepIndex = 0;
            let successCount = 0;
            let failCount = 0;

            function showNotice(message, type = 'error'){
                noticeEl.textContent = message;
                noticeEl.className = 'notice ' + (type === 'success' ? 'notice--success' : 'notice--error');
                noticeEl.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function loadStep(idx){
                const step = steps[idx];
                questionEl.textContent = step.prompt;
                helperEl.textContent = 'Choose exactly 3 images, then click Verify.';
                helperEl.classList.remove('helper--warn');
                for (const key of Object.keys(imgEls)) {
                    imgEls[key].src = step.images[key];
                }
                // clear selections
                document.querySelectorAll('.answer').forEach(cb => cb.checked = false);
            }

            function getSelected() {
                return Array.from(document.querySelectorAll('.answer:checked')).map(el => el.id);
            }

            loadStep(stepIndex);

            // Refresh: reshuffle and reset to first step
            refreshBtn.addEventListener('click', function(){
                steps = stepsMeta.map(generateStep);
                stepIndex = 0;
                successCount = 0;
                failCount = 0;
                loadStep(stepIndex);
            });

            // Close: navigate back one page if possible
            closeBtn.addEventListener('click', function(){
                if (history.length > 1) history.back();
                else window.location.href = 'registration.html';
            });

            verifyBtn.addEventListener('click', function(){
                const selected = getSelected();
                if (selected.length !== required) {
                    helperEl.textContent = `Please select exactly ${required} images.`;
                    helperEl.classList.add('helper--warn');
                    return;
                }
                const correctSet = steps[stepIndex].correct;
                const ok = selected.every(id => correctSet.has(id));

                if (ok) {
                    successCount += 1;
                } else {
                    failCount += 1;
                }

                // Advance to next step or finish
                stepIndex += 1;
                if (stepIndex < steps.length) {
                    loadStep(stepIndex);
                } else {
                    // Finished 3 attempts. Fail if there is any failed step (1, 2, or 3 out of 3)
                    if (failCount >= 1) {
                        showNotice(`Verification failed. You failed ${failCount} out of 3 attempts.`,'error');
                        // Refresh images for a new run: regenerate steps and reset counters
                        steps = stepsMeta.map(generateStep);
                        stepIndex = 0;
                        successCount = 0;
                        failCount = 0;
                        loadStep(stepIndex);
                    } else {
                        window.location.href = 'login.html?message=verification_successful';
                    }
                }
            });
        </script>
    
    </body>